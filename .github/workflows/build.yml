name: Build LICEcap (macOS)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

jobs:
  macos:
    name: macOS build (xcodebuild)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # PHP is required by licecap/makedmg.sh (a PHP script) to package a DMG.
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Verify PHP
        run: php -v

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Build licecap.app (Release)
        working-directory: licecap
        run: |
          set -euxo pipefail
          # Build without code signing to avoid CI requirements
          # Add compiler flags to fix WDL/zlib compatibility issues
          xcodebuild \
            -project licecap.xcodeproj \
            -scheme licecap \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO \
            OTHER_CFLAGS="-DSTDC=1 -DHAVE_UNISTD_H=1 -D_LARGEFILE64_SOURCE=0 -D_SYS16BIT_=0 -DMSDOS=0 -D__STDC_VERSION__=201112L" \
            GCC_PREPROCESSOR_DEFINITIONS="\$(inherited) STDC=1 HAVE_UNISTD_H=1 _LARGEFILE64_SOURCE=0" \
            build

          echo "Built products:"
          ls -la build/Build/Products/Release || true

      - name: Package licecap.app as zip
        working-directory: licecap
        run: |
          set -euxo pipefail
          mkdir -p build/artifacts
          # Zip the .app bundle with resource forks preserved
          pushd build/Build/Products/Release
          if [ ! -d "licecap.app" ]; then
            echo "ERROR: licecap.app not found"
            ls -la
            exit 1
          fi
          ditto -c -k --sequesterRsrc --keepParent licecap.app licecap.app.zip
          popd
          cp build/Build/Products/Release/licecap.app.zip build/artifacts/

      - name: Optional DMG packaging via PHP script
        working-directory: licecap
        run: |
          set -euxo pipefail
          # makedmg.sh expects build/Release/LICEcap.app; create that layout from DerivedData
          mkdir -p build/Release
          rm -rf build/Release/LICEcap.app || true
          cp -R build/Build/Products/Release/licecap.app "build/Release/LICEcap.app"

          # Run the PHP-based packager to produce a DMG; no signing in CI
          php ./makedmg.sh

          # Collect DMG if produced
          mkdir -p build/artifacts
          # The script writes as build/licecap<ver>.dmg; grab any DMG it created
          if ls build/licecap*.dmg 1> /dev/null 2>&1; then
            cp build/licecap*.dmg build/artifacts/
          fi

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: licecap-macos
          path: |
            licecap/build/artifacts/*
          if-no-files-found: error
